[from-internal]
{% if telefonefix_super_user_override_prefix is defined %}
; Super user override pattern - bypasses time restrictions
exten => _{{ telefonefix_super_user_override_prefix }}1XX,1,NoOp(Super user override call to extension ${EXTEN:{{ telefonefix_super_user_override_prefix|length }}})
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,Set(TARGET_EXT=${EXTEN:{{ telefonefix_super_user_override_prefix|length }}})
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,Set(TRANSLATED_NUMBER=${SHELL(allo-wed -config /opt/asterisk/allo-wed.yml -phone ${TARGET_EXT})})
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,NoOp(Override call - translated to: ${TRANSLATED_NUMBER})
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,GotoIf($["${TRANSLATED_NUMBER}" = ""]?not_allowed)
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,Playback(extra/${TARGET_EXT}/connecting)
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,Dial(PJSIP/${TRANSLATED_NUMBER}@twilio,30,L({{ telefonefix_call_duration_limit_minutes * 60 * 1000 }}))
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?noanswer)
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,GotoIf($["${DIALSTATUS}" = "UNAVAILABLE"]?unavailable)
exten => _{{ telefonefix_super_user_override_prefix }}1XX,n,Hangup()
{% endif %}

; Pattern _1XX matches any three-digit number starting with 1
exten => _1XX,1,NoOp(Calling extension ${EXTEN})
exten => _1XX,n,Set(TRANSLATED_NUMBER=${SHELL(allo-wed -config /opt/asterisk/allo-wed.yml -is-allowed -phone ${EXTEN})})
exten => _1XX,n,NoOp(Translated to: ${TRANSLATED_NUMBER})
exten => _1XX,n,GotoIf($["${TRANSLATED_NUMBER}" = ""]?not_allowed)

; Call is allowed and number was translated
exten => _1XX,n,Playback(extra/${EXTEN}/connecting)
exten => _1XX,n,Dial(PJSIP/${TRANSLATED_NUMBER}@twilio,30,L({{ telefonefix_call_duration_limit_minutes * 60 * 1000 }}))
exten => _1XX,n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
exten => _1XX,n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?noanswer)
exten => _1XX,n,GotoIf($["${DIALSTATUS}" = "UNAVAILABLE"]?unavailable)
exten => _1XX,n,Hangup()

; Call not allowed or no mapping found
exten => _1XX,n(not_allowed),Playback(extra/${EXTEN}/not-allowed)
exten => _1XX,n,Hangup()

; Busy handling
exten => _1XX,n(busy),Playback(extra/${EXTEN}/currently-busy)
exten => _1XX,n,Hangup()

; No answer handling
exten => _1XX,n(noanswer),Playback(extra/${EXTEN}/unavailable)
exten => _1XX,n,Hangup()

; Unavailable handling
exten => _1XX,n(unavailable),Playback(extra/${EXTEN}/unavailable)
exten => _1XX,n,Hangup()

; For debugging purpose
exten = 200,1,Answer()
same = n,Wait(1)
same = n,Playback(en/hello-world)
same = n,Hangup()
